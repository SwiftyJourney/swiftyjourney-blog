---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const slugify = (tag) =>
		tag
			.trim()
			.toLowerCase()
			.replace(/[^a-z0-9]+/g, "-")
			.replace(/^-+|-+$/g, "");

	const allPosts = await getCollection("blog");
	const posts = allPosts.filter((post) => post.data.lang === "es");
	const tagMap = new Map();

	for (const post of posts) {
		for (const tag of post.data.tags ?? []) {
			const slug = slugify(tag);
			if (!slug) continue;
			if (!tagMap.has(slug)) {
				tagMap.set(slug, tag);
			}
		}
	}

	return Array.from(tagMap.entries()).map(([slug, label]) => ({
		params: { tag: slug },
		props: { tagSlug: slug, tagLabel: label },
	}));
}

const slugify = (tag) =>
	tag
		.trim()
		.toLowerCase()
		.replace(/[^a-z0-9]+/g, "-")
		.replace(/^-+|-+$/g, "");

const { tagSlug, tagLabel } = Astro.props;
const allPosts = await getCollection("blog");
const posts = allPosts
	.filter((post) => post.data.lang === "es")
	.filter((post) =>
		(post.data.tags ?? []).some((tag) => slugify(tag) === tagSlug),
	)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout
	title={`${tagLabel} — Swifty Journey`}
	description={`Artículos etiquetados con ${tagLabel}`}
	lang="es"
>
	<div class="py-12">
		<div class="mb-10">
			<h1 class="text-3xl md:text-4xl font-bold text-zinc-900 dark:text-zinc-100 mb-3">
				{tagLabel}
			</h1>
			<p class="text-zinc-600 dark:text-zinc-400">
				{posts.length} artículo{posts.length === 1 ? "" : "s"}
			</p>
		</div>

		<div class="grid gap-6">
			{posts.map((post) => (
				<a
					href={`/es/blog/${post.data.slug}/`}
					class="block rounded-xl border border-zinc-200 dark:border-zinc-800 p-6 hover:border-orange-300 dark:hover:border-orange-500/50 transition-colors"
				>
					<div class="text-sm text-zinc-500 dark:text-zinc-400 mb-2">
						{post.data.pubDate.toLocaleDateString("es-ES", {
							year: "numeric",
							month: "short",
							day: "numeric",
						})}
					</div>
					<div class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">
						{post.data.title}
					</div>
					<p class="text-zinc-600 dark:text-zinc-400 mt-2">
						{post.data.description}
					</p>
				</a>
			))}
		</div>
	</div>
</BaseLayout>
