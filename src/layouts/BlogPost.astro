---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import ArticleInfo from "../components/ArticleInfo.astro";
import readingTime from "reading-time";

type Props = CollectionEntry<"blog">["data"] & {
	lang?: "en" | "es";
	translationKey?: string;
	rawContent?: string;
};

const {
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	lang = "es",
	translationKey,
	rawContent,
	tags,
	slug,
} = Astro.props;

const siteUrl = Astro.site?.toString() ?? "https://blog.swiftyjourney.com";
const canonical = new URL(Astro.url.pathname, siteUrl).toString();
const ogImage = heroImage ? new URL(heroImage.src, siteUrl).toString() : undefined;
const ogImageWidth = heroImage?.width;
const ogImageHeight = heroImage?.height;

// Calculate reading time if rawContent is provided
const readingTimeResult = rawContent ? readingTime(rawContent) : null;
const readingTimeText = readingTimeResult
	? lang === "en"
		? readingTimeResult.text
		: `${readingTimeResult.minutes} min de lectura`
	: lang === "en"
		? "5 min read"
		: "5 min de lectura";

// Find the translated version of this post
const allPosts = await getCollection("blog");
const translatedPost = allPosts.find(
	(post) =>
		post.data.translationKey === translationKey && post.data.lang !== lang,
);

const normalizeTag = (tag: string) =>
	tag
		.trim()
		.toLowerCase()
		.replace(/[^a-z0-9]+/g, "-")
		.replace(/^-+|-+$/g, "");

const currentTagSlugs = tags?.map(normalizeTag) ?? [];
const relatedByTags =
	currentTagSlugs.length > 0
		? allPosts.filter(
				(post) =>
					post.data.lang === lang &&
					post.data.slug !== slug &&
					(post.data.tags ?? []).some((tag) =>
						currentTagSlugs.includes(normalizeTag(tag)),
					),
			)
		: [];

const relatedPosts =
	relatedByTags.length > 0
		? relatedByTags
		: allPosts
				.filter(
					(post) => post.data.lang === lang && post.data.slug !== slug,
				)
				.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
				.slice(0, 3);

const jsonLd = {
	"@context": "https://schema.org",
	"@type": "Article",
	headline: title,
	description,
	keywords: tags?.join(", "),
	inLanguage: lang,
	datePublished: pubDate.toISOString(),
	dateModified: (updatedDate ?? pubDate).toISOString(),
	mainEntityOfPage: canonical,
	author: {
		"@type": "Organization",
		name: "Swifty Journey",
	},
	publisher: {
		"@type": "Organization",
		name: "Swifty Journey",
	},
	image: ogImage ? [ogImage] : undefined,
};

// Generate URLs for language toggle
const currentPath = Astro.url.pathname;
const toEn =
	translatedPost && lang === "es"
		? `/en/blog/${translatedPost.data.slug ?? translatedPost.id.split("/").pop()}/`
		: "/en/";
const toEs =
	translatedPost && lang === "en"
		? `/es/blog/${translatedPost.data.slug ?? translatedPost.id.split("/").pop()}/`
		: "/es/";
---

<BaseLayout
	title={title}
	description={description}
	lang={lang}
	toEn={toEn}
	toEs={toEs}
	ogType="article"
	ogImage={ogImage}
	ogImageWidth={ogImageWidth}
	ogImageHeight={ogImageHeight}
	articlePublishedTime={pubDate.toISOString()}
	articleModifiedTime={updatedDate ? updatedDate.toISOString() : undefined}
	jsonLd={jsonLd}
>
	<article class="py-12">
		<!-- Hero Image -->
		{
			heroImage && (
				<div class="mb-16">
					<Image
						src={heroImage}
						alt={title}
						width={1200}
						height={600}
						class="w-full max-w-3xl mx-auto rounded-lg"
						loading="eager"
					/>
				</div>
			)
		}

		<!-- Article Header -->
		<header class="max-w-3xl mx-auto px-4 mb-16 text-center">
			<ArticleInfo
				readingTime={readingTimeText}
				pubDate={pubDate}
				updatedDate={updatedDate}
				lang={lang}
			/>
			<h1
				class="text-3xl md:text-5xl font-bold text-zinc-900 dark:text-zinc-100 my-8"
			>
				{title}
			</h1>
			{
				description && (
					<p class="text-xl text-zinc-600 dark:text-zinc-400 leading-relaxed">
						{description}
					</p>
				)
			}
			{
				tags && tags.length > 0 && (
					<div class="mt-6 flex flex-wrap justify-center gap-2">
						{tags.map((tag) => (
							<a
								href={`/${lang}/tags/${normalizeTag(tag)}/`}
								class="text-xs uppercase tracking-wide px-3 py-1 rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-300 hover:text-orange-500 hover:border-orange-300 dark:hover:text-orange-300 transition-colors"
							>
								{tag}
							</a>
						))}
					</div>
				)
			}
		</header>

		<!-- Article Content -->
		<div class="max-w-3xl mx-auto px-4 prose">
			<slot />
		</div>

		{
			relatedPosts.length > 0 && (
				<div class="max-w-3xl mx-auto px-4 mt-16">
					<h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100 mb-6">
						{lang === "en" ? "Related posts" : "Art√≠culos relacionados"}
					</h2>
					<div class="grid gap-6 md:grid-cols-3">
						{relatedPosts.map((post) => (
							<a
								href={`/${lang}/blog/${post.data.slug}/`}
								class="block rounded-xl border border-zinc-200 dark:border-zinc-800 p-4 hover:border-orange-300 dark:hover:border-orange-500/50 transition-colors"
							>
								<div class="text-sm text-zinc-500 dark:text-zinc-400 mb-2">
									{post.data.pubDate.toLocaleDateString(
										lang === "en" ? "en-US" : "es-ES",
										{ year: "numeric", month: "short", day: "numeric" },
									)}
								</div>
								<div class="font-semibold text-zinc-900 dark:text-zinc-100">
									{post.data.title}
								</div>
							</a>
						))}
					</div>
				</div>
			)
		}

		<!-- Back to Blog -->
		<div
			class="max-w-3xl mx-auto px-4 mt-16 pt-8 border-t border-zinc-200 dark:border-zinc-700"
		>
			<a
				href={`/${lang}/blog`}
				class="inline-flex items-center gap-2 text-orange-500 hover:text-orange-600 dark:text-orange-400 dark:hover:text-orange-300 transition-colors"
			>
				<svg
					class="w-4 h-4"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M15 19l-7-7 7-7"></path>
				</svg>
				{lang === "en" ? "Back to blog" : "Volver al blog"}
			</a>
		</div>
	</article>
</BaseLayout>
